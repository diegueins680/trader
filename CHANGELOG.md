# Changelog
All notable changes to this project will be documented in this file.

## Unreleased
- Trading: default `binanceLive` to on for CLI/API, add `--no-binance-live` to force test orders.
- Web UI: default Live orders + Trading armed toggles to on.
- Deploy: quick AWS deploy now defaults `TRADER_BOT_TRADE=true` unless overridden.
- Optimizer: replace the Python optimizer scripts with Haskell executables (`optimize-equity`, `merge-top-combos`) and route `/optimizer/run` through them.
- Optimizer: `/optimizer/run` JSON parsing accepts numeric strings (including `nan`/`inf`) for legacy compatibility.
- Optimizer: JSON outputs use stable key ordering for deterministic diffs.
- Ops: restore the newest `ops.jsonl` from S3 on boot and sync on a timer when `TRADER_STATE_S3_BUCKET` is set, configurable via `TRADER_OPS_S3_EVERY_SEC`.
- Optimizer: always refresh at least the top 5 combos with latest backtests, even when equity drops.
- Live bot: API auto-starts for `TRADER_BOT_SYMBOLS` (or `--binance-symbol`) with trading enabled by default and restarts on the next poll interval if stopped.
- Live bot: top-combo sync treats interval-less combos as compatible with the current interval.
- Observability: log Binance API requests (`binance.request`) and minute-by-minute bot status snapshots (`bot.status`), plus a live/offline timeline chart in the UI.
- Observability: redact Binance query params in ops logs even when the query string starts with `?`.
- Observability: ensure ops logging covers all Binance API calls (including listenKey/trades/positions/data fetches) and emit an immediate `bot.status` snapshot on bot start.
- Trading: when confidence sizing is enabled, scale live orders and backtests by LSTM confidence (thresholds now configurable).
- Trading: futures order placement checks available balance (and leverage) before submitting.
- Trading: add `--method router` with `--router-lookback`/`--router-min-score` for adaptive Kalman/LSTM/blend selection.
- Trading: router signals now apply Kalman confidence/risk gates to routed selections (including LSTM-routed bars).
- Backtests: router scoring now uses the effective open threshold (including cost-aware min-edge floors).
- Backtests: router agreement rate now reflects Kalman vs LSTM agreement instead of routed predictions.
- Trading: add tri-layer exits on slow Kalman crosses, optional Kalman-band exits, and a strong LSTM flip-exit toggle.
- Trading: require a slow-line cross for tri-layer exits, trigger Kalman-band exits on candle high/low hits, and disable band sampling when the lookback is < 2.
- Predictors: fall back to the GBDT base prediction when feature dimensions mismatch.
- Web UI: default order sizing uses `orderQuote=100` to avoid orders rounding to zero on common minQty/step sizes.
- Backtests: API queues requests when the backtest slot is busy; UI waits and notifies when the backtest completes.
- Strategy defaults: move to `--interval 1h`/`--lookback-window 7d`, raise baseline risk filters (min SNR, trend lookback, hold/cooldown/max-hold, max position size, vol target/floor/max-vol, Kalman z-min, min position size), and bump cost assumptions (fee/slippage/spread).
- Strategy defaults: enable cost-aware edge, conformal/quantile confirmations, and confidence sizing by default, with `--no-cost-aware-edge`, `--no-confirm-conformal`, `--no-confirm-quantiles`, and `--no-confidence-sizing` opt-outs.
- Optimizer defaults: switch to `equity-dd-turnover` with higher drawdown/turnover penalties, longer lookback windows, and 1h-1d interval sampling.
- Observability: add Discord-compatible webhook notifications for bot/trade events via `TRADER_WEBHOOK_URL` (filter with `TRADER_WEBHOOK_EVENTS`).
- Live bot: support multi-symbol bots via `botSymbols` and `TRADER_BOT_SYMBOLS`, with per-symbol status snapshots.
- Live bot: auto-syncs to the latest top combo (poll interval `TRADER_BOT_COMBOS_POLL_SEC`) and applies it while running.
- Live bot: always adopts existing positions on startup (`botAdoptExistingPosition` is now implicit).
- Live bot: startup waits for the top combo compatible with adopted positions or open orders before running.
- Live bot: `/bot/start` auto-adopts orphan open futures positions when a matching top combo exists.
- Live bot/API: futures position checks now respect hedge-mode sides; bot start/adoption and futures trade requests reject simultaneous long+short positions for the same symbol.
- Ops: add a cron watchdog script to keep the live bot running (`deploy/ensure-bot-running.sh`).
- Ops: fix the cron watchdog JSON parsing in zsh so `/bot/status` checks succeed.
- Ops: include `binanceSymbol` in multi-symbol watchdog start payloads to satisfy API data-source validation.
- API: add `/binance/trades` for full Binance account trade history (spot/margin require symbol; futures supports all).
- API: add `/binance/positions` for open Binance futures positions plus chart-ready klines.
- API: `/signal` endpoints now validate request parameters the same way as CLI invocations.
- Web UI: add Binance account trades panel powered by `/binance/trades`.
- Web UI: add an open positions panel with charts for every Binance futures position.
- Web UI: orphaned operations panel now matches by market + hedge side and labels orphan reasons (market mismatch, stopped, trading disabled, side mismatch).
- Web UI: add an orphaned operations panel that highlights open futures positions not currently adopted by a running bot.
- Web UI: auto-load open positions charts on page load, interval/market changes, and Binance key/auth updates (including API token changes).
- Web UI: bot state timeline hover now shows the corresponding timestamp.
- Web UI: open positions/orphaned operations cards key by position side, ignore bots with trade disabled when determining adoption, and label trade-off bots explicitly.
- Web UI: Fix button clamps bars/epochs/hidden size to API limits when exceeded.
- Web UI: backtest split auto-adjusts bars without exceeding API max bars.
- Backtests: add `--rebalance-global`, `--rebalance-reset-on-signal`, `--funding-by-side`, and `--funding-on-open` toggles for rebalance cadence and funding timing/sign controls (CLI warns on negative funding without side-signing).
- Metrics: agreement rate now counts only bars where both models emit a direction (warm-up/no-signal bars excluded).
- Backtests: validate open timestamp vectors against closes to avoid misaligned day boundaries.
- Web UI: Binance account trades time filters accept unix ms timestamps or ISO-8601 dates (YYYY-MM-DD or YYYY-MM-DDTHH:MM).
- Web UI: validate symbol formats per platform and require non-negative Binance trades From ID inputs.
- Web UI: live bot controls support multi-symbol start/stop and per-bot selection.
- Web UI: warn when the bot status timeline range falls outside available ops history.
- Web UI: send explicit zero/false values for default-on risk settings so disable toggles take effect.
- Deploy: quick AWS deploy supports S3 state configuration and optional App Runner instance roles.
- Deploy: quick AWS deploy reuses existing App Runner S3 state settings + instance role when updating a service unless new values are provided.
- Deploy: quick AWS deploy now exports `TRADER_API_MAX_HIDDEN_SIZE` (defaults to 50) for larger LSTM models.
- Deploy: quick AWS deploy now forwards `TRADER_BOT_SYMBOLS`, `TRADER_BOT_SYMBOL`, and `TRADER_BOT_TRADE` into App Runner runtime env.
- Deploy: quick AWS deploy now forwards `BINANCE_API_KEY` and `BINANCE_API_SECRET` into App Runner runtime env when set.
- Deploy: quick AWS deploy auto-configures CloudFront `/api/*` behavior to route to the API and disable caching.
- Deploy/UI: quick AWS deploy now forces UI `apiBaseUrl` to `/api` when CloudFront is configured and docs call out the single-instance requirement behind non-sticky proxies.
- Deploy/UI: quick AWS deploy supports `--ui-api-direct`/`TRADER_UI_API_MODE=direct` to keep `apiBaseUrl` pointing at the API host even with CloudFront.
- Deploy/UI: quick AWS deploy auto-discovers the App Runner service ARN/token for UI-only deploys when not provided.
- Deploy/UI: quick AWS deploy now auto-fills `apiFallbackUrl` with the App Runner URL when CloudFront `/api/*` is configured (override with `--ui-api-fallback`).
- Web UI: async signal/backtest start requests can fail over to `apiFallbackUrl` when the `/api` proxy returns 5xx/HTML errors.
- Deploy/UI: quick AWS deploy supports `--ui-api-fallback`/`TRADER_UI_API_FALLBACK_URL` to set `apiFallbackUrl`.
- CLI/API: accept `long-only`/`long` as aliases for `--positioning long-flat`.
- Exchange data: add Kraken/Poloniex alongside Binance (`--platform`, `--symbol` alias) with trading only on Binance/Coinbase.
- Exchange data: add Coinbase platform support for exchange klines and spot trading.
- Trading: Coinbase spot orders now supported via `/trade` and `--binance-trade` (live-only; no test endpoint).
- Optimizer: add platform sampling (`--platforms`) and persist platform in top-combo outputs.
- Optimizer: allow `merge-top-combos --max 0` to emit an empty combo list.
- Optimizer: avoid crashes when random sampling pools are empty (skips invalid picks).
- Optimizer: refresh the top-N combos daily by re-running backtests against the latest data and persisting updated metrics to `top-combos.json`.
- API: prefer local bot snapshots and optimizer combos on reads, falling back to S3 only when local state is missing to reduce proxy 5xx.
- API: add backtest concurrency gating + timeout controls (`TRADER_API_MAX_BACKTEST_RUNNING`, `TRADER_API_BACKTEST_TIMEOUT_SEC`) to keep the server responsive under heavy backtests.
- Web UI: add platform selector with per-exchange symbols/intervals and disable Binance-only actions when not on Binance.
- Web UI: store and check API keys per platform (Binance/Coinbase) and show Coinbase symbol defaults.
- Web UI: optimizer combo rows are preview-only with explicit Apply actions plus refresh/apply-top shortcuts.
- Web UI: let users choose how many optimizer combos to display (default 5, capped by available combos).
- Web UI: top combos now auto-apply when available to keep the form aligned with the top performer.
- Web UI: idle live bot auto-starts after the top combo is applied.
- API: futures MIN_NOTIONAL parsing now honors the `notional` field to skip trade tests below minNotional.
- Web UI: API panel adds base URL copy + /health open shortcuts; loading a profile clears manual override locks.
- Web UI: add quick-jump buttons in the config panel to navigate major sections.
- Web UI: improve keyboard navigation with focus-on-jump shortcuts, clearer focus rings, and reduced-motion friendly scrolling.
- Web UI: Data Log adds an auto-scroll toggle to keep the latest entries visible.
- Web UI: Data Log adds label filtering with copy-shown support plus clear-filter/jump-to-latest actions.
- Web UI: numeric inputs accept comma decimals and strip thousands separators; auto-refresh interval input disables when off.
- Web UI: router mode clears optimize/sweep toggles and omits them from API requests.
- Web UI: add a sticky run bar in the configuration panel showing readiness issues and keeping run actions visible.
- Web UI: add section headings plus issue shortcuts that jump and highlight the relevant inputs.
- Web UI: when trading is armed, automatically switches Market to Futures when Positioning is set to Long/Short.
- Web UI: falls back to `GET` for async polling when `POST` hits proxy errors (e.g. 502/503).
- Web UI: optional `apiFallbackUrl` in `trader-config.js` to fail over to a direct API host when `/api` proxies return 502/503/504.
- Web UI: treat non-JSON or invalid JSON `/api` responses (e.g., HTML from misrouted proxies) as failures and retry via `apiFallbackUrl`.
- Web UI: async signal/backtest starts retry transient 5xx/timeouts without using `apiFallbackUrl`, and cross-origin fallback is disabled for the session after a network/CORS failure.
- Web UI: show a backtest/tune split preview with minimum bars required for the current lookback.
- Web UI: avoid optimizer combo apply crashes when compute limits are unavailable.
- Backtests: risk halts now record `MAX_DRAWDOWN`/`MAX_DAILY_LOSS` as trade exit reasons.
- Backtests: risk halts now evaluate post-bar equity and can close positions at the bar close.
- Backtests: `agreementOk` now counts open-direction agreement only when both models emit a direction.
- Backtests: error when lookback bars are not less than the total bar count (prevents silent no-trade runs).
- API/Backtests: reject inconsistent high/low/prediction lengths with 400 errors instead of crashing.
- Trading: daily-loss halts reset at UTC day boundaries when bar timestamps are available (exchange/CSV timestamps; otherwise interval-based).
- Trading: entries gated by `--min-signal-to-noise`, `--max-volatility`, or `--vol-target` now wait for a volatility estimate.
- Trading: latest signals now apply the same volatility gating and confidence close-direction gating (including blend) as backtests, without applying min-position-size to exits.
- Trading: conformal/quantile confirmations use the close threshold when gating close signals.
- Trading: add optional tri-layer entry gating (Kalman cloud trend + price-action reversal triggers) via `--tri-layer`.
- Trading: min-position-size only gates entries when confidence sizing is enabled, and close-direction gating no longer applies the min-position-size threshold.
- Live bot: startup close decisions for adopted positions now use the gated closeDirection logic (matching the run loop).
- Live bot: close decisions now use the gated closeDirection logic during the run loop.
- Live bot: bracket exits now honor stop-loss/take-profit/trailing vol-mult overrides.
- Backtests: add volatility-targeted rebalancing (`--rebalance-bars`, `--rebalance-threshold`) and optional funding/borrow drag (`--funding-rate`).
- Backtests: `--backtest-ratio` now errors if the split leaves too few training/backtest bars (no silent clamping).
- Backtests: ignore mismatched open-time series and fall back to interval-based day boundaries.
- Optimizer: threshold sweeps now nudge candidate thresholds below observed edges to avoid equality edge cases.
- Live bot: risk halts now record `MAX_DRAWDOWN`/`MAX_DAILY_LOSS` exit reasons even if a signal exit coincides.
- Kalman market context now honors small `--kalman-market-top-n` values when enough symbols are available.
- Tuning: sweep/optimization validates prediction lengths before scoring to avoid crashes.
- Trading/Tuning: add blend method, min-edge/cost-aware edge gating, max-hold exits, trend/volatility sizing filters, and stress-weighted tune scoring.
- Trading: max-hold exits now enforce a 1-bar cooldown before re-entry.
- Trading: add signal-to-noise entry filter plus volatility-multiple stop-loss/take-profit/trailing options.
- Normalization: `minmax`/`standard` fall back to no-op when the fit window is empty or only contains non-finite values; `log` now falls back to no-op when the fit window is empty or contains non-finite/non-positive values.
- Predictors: conformal intervals now calibrate on a holdout split; predictor training validates feature dimensions and fails fast on mismatches.
- Predictors: conformal sigma is omitted when calibration is empty or interval width is invalid; quantile sigma is omitted when q10/q90 are invalid or identical.
- Predictors: conformal sigma now derives from alpha with a conformal quantile rank; quantile medians are clamped inside q10/q90.
- Predictors: training now excludes the calibration split for all models to avoid leakage.
- Predictors: skip GBDT/quantile/conformal outputs when the feature dataset is empty to avoid crashes.
- Predictors: feature windows now drop zero-price returns and use sample variance for volatility features.
- Predictors: add a lightweight benchmark harness (`trader-bench`) for quick performance checks.
- Performance: reduce list indexing and allocation hotspots in predictors, metrics, and symbol dedupe.
- Web UI: improves async job not found handling with a clearer error after the grace period.
- Web UI: fixes a startup crash when optimizer combos apply before API compute limits are available.
- Web UI: show optimizer combo source (API vs static) and last update time.
- Web UI: show optimizer combo counts and increase the default list to 12 combos.
- Web UI: optimizer combo loads preserve the current positioning unless the combo explicitly specifies one.
- Web UI: hides the Agree overlay for LSTM-only backtests and clarifies bars=0 combo behavior.
- Web UI: optimizer combo refresh errors keep the last known combos visible with a warning.
- API/Trading: latest signals include `closeDirection`, and live order decisions respect `closeThreshold` for exits.
- Web UI: manual Method/open/close edits are preserved when optimizer combos or optimize/sweep results apply.
- Web UI: optimizer combos now persist/show the operations that produced each top result on hover.
- Web UI: add auto-apply toggle with last-applied marker, manual override lock/unlock hints, and a cross-origin API base warning.
- Web UI: show persisted live-bot snapshots when `/bot/status` is restored after restart.
- Web UI: auto-adjust bars/backtest ratio on backtest/optimize runs when the split would be invalid.
- Live bot/UI: `/bot/status` includes `startingReason` and the UI surfaces when startup is waiting for a compatible top combo.
- API: `/bot/status` now caps the `tail` parameter to 5000 points.
- API: `/bot/status` tail now clamps open trade entries so open positions remain visible.
- API: enforce `TRADER_API_MAX_BODY_BYTES` for request payloads (default 1048576 bytes).
- API: `/optimizer/run` responses now truncate stdout/stderr to `TRADER_API_MAX_OPTIMIZER_OUTPUT_BYTES` (default 20000 bytes).
- API: classify internal `ErrorCall` failures as server errors instead of client errors.
- Optimizer: S3-persisted top combos are merged into new optimizer runs to keep best-ever results.
- Optimizer: threshold sweeps now prefer higher open/close thresholds when scores tie.
- Optimizer: `top-combos.json` now includes a `bestOptimizationTechniques` list summarizing recommended search approaches and records which techniques were applied (Sobol seeding, successive halving, Bayesian-style exploitation, walk-forward validation, ensemble summary).
- Predictors: guard empty TCN dilations to avoid crashes.
- API: `/bot/start` error responses include per-symbol errors when all requested symbols fail.
- Web UI: live bot start/status errors surface CloudFront `/api/*` proxy hints and avoid a stuck `Starting...` state when the API is down.
- Live bot: support long/short positioning on Binance futures (including adopting/closing existing short positions).
- Optimizer: adds a `--quality` preset plus CSV high/low auto-detection for deeper equity searches.
- Optimizer: adds trade-quality filters (win rate, profit factor, exposure) and samples min-hold/cooldown bars for churn control.
- Optimizer: adds min-signal-to-noise sampling plus Sharpe/walk-forward Sharpe filters, with `/optimizer/run` fields to match.
- Optimizer: adds walk-forward/tune-stress sampling controls and propagates additional combo parameters (vol floors, vol caps, stress settings) through top-combo outputs.
- Optimizer: auto optimizer biases long-short sampling to match existing open positions/orders so compatible combos appear sooner.
- Optimizer: adds sampling ranges for max-hold bars, blend weight, entry gating (incl. cost-aware-edge probability), position/vol sizing (incl. vol-floor/max-volatility/periods-per-year), Kalman market-top-n, tune objective passthrough, and bars auto/distribution controls.
- Optimizer: add tri-layer cloud noise sampling (`--p-tri-layer`, `--tri-layer-fast-mult-min/max`, `--tri-layer-slow-mult-min/max`).
- Optimizer: when sampling default-on flags (cost-aware edge, conformal/quantile confirmation, confidence sizing), emit the matching `--no-*` flags so disables take effect.
- Trading: add tri-layer cloud slope/width/touch/body controls, LSTM flip exit grace bars, and configurable LSTM confidence thresholds.
- Optimizer/API: expose tri-layer cloud slope/width/touch/body ranges plus LSTM flip grace + confidence threshold sampling.
- Backtests: slice exchange open-time vectors for walk-forward folds to avoid length mismatches.
- Optimizer/API: expose intrabar fill probability, bracket-stop ranges (incl. vol-mult), confidence gating, and LSTM training sampling controls to `/optimizer/run`.
- Optimizer: threshold sweep tie-breakers now prefer higher final equity, then lower turnover/more round trips, and avoid inverted hysteresis unless equity is unchanged.
- Optimizer: top-combo merges compare scores only within the same objective, fall back to final equity across objectives, and break ties by final equity.
- Optimizer: truncated trial errors now use the legacy ellipsis marker (`â€¦`).
- Optimizer: accept numeric strings for backtest numeric fields and treat invalid threshold values as schema errors.
- Optimizer: pretty-printed JSON output now uses stable, sorted keys.
- LSTM: persistence keys now include exchange platform to avoid cross-exchange weight reuse.
- Optimizer: raise the default `TRADER_OPTIMIZER_MAX_COMBOS` cap to 200 and archive top-combos snapshots locally/S3 for history.
- API: `/optimizer/run` now accepts the expanded optimizer sampling, tune-objective, and Kalman/volatility sizing parameters.
- API: `/optimizer/run` now merges optimizer runs into `top-combos.json` (bounded by `TRADER_OPTIMIZER_MAX_COMBOS`).
- API: allow `/optimizer/combos` to persist top-combos.json via `TRADER_OPTIMIZER_COMBOS_DIR`.
- API: persist `/bot/status` snapshots via `TRADER_BOT_STATE_DIR` so the last state survives restarts.
- API: optionally persist bot snapshots + optimizer combos to S3 via `TRADER_STATE_S3_BUCKET`.
- API: add `TRADER_STATE_DIR` to persist ops/journal/bot state/optimizer combos/async jobs/LSTM weights under one shared directory.
- Deploy: Docker image and quick AWS deploy default `TRADER_STATE_DIR` to `/var/lib/trader/state` (now configurable via `deploy-aws-quick.sh --state-dir`).
- Deploy: when using CloudFront with a distribution ID, the quick AWS deploy script sets the UI API base to `/api` to avoid CORS.
- Deploy: quick AWS deploy now prints the CloudFront domain and warns when `/api/*` behavior is missing.
- API: rounds `/binance/keys` test order quantities to the symbol step size to avoid precision errors.
- API/UI: `/binance/keys` trade probes report `skipped` when no test order is attempted, and the UI shows `SKIP` instead of `FAIL`.
- API: `/binance/keys` preflight checks minNotional when price data is available and only fetches symbol filters when needed.
- API: add `/coinbase/keys` for Coinbase API key checks (includes passphrase).
- API: enables async job persistence by default (local `.tmp/async`); set `TRADER_API_ASYNC_DIR` to override or disable.
- Exchange data: Poloniex candles now use the `/markets/{symbol}/candles` API with `BASE_QUOTE` symbols (legacy `QUOTE_BASE` is auto-swapped).
